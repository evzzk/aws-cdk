"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = require("path");
const core = require("aws-cdk-lib/core");
const cli = require("aws-cdk/lib");
const lib_1 = require("../lib");
// These tests synthesize an actual CDK app and take a bit longer
jest.setTimeout(60000);
jest.mock('aws-cdk/lib', () => {
    const original = jest.requireActual('aws-cdk/lib');
    return {
        ...original,
        exec: jest.fn(original.exec),
    };
});
const stdoutMock = jest.spyOn(process.stdout, 'write').mockImplementation(() => { return true; });
beforeEach(() => {
    stdoutMock.mockClear();
    jest.mocked(cli.exec).mockClear();
});
afterAll(() => jest.clearAllMocks());
describe('fromCloudAssemblyDirectoryProducer', () => {
    const testEnv = jest.fn();
    const cdk = lib_1.AwsCdkCli.fromCloudAssemblyDirectoryProducer({
        produce: async () => {
            const app = new core.App();
            new core.Stack(app, 'Stack1');
            new core.Stack(app, 'Stack2');
            testEnv(process.env);
            return app.synth().directory;
        },
    });
    beforeEach(() => {
        testEnv.mockClear();
    });
    test('can list all stacks in app', async () => {
        // WHEN
        await cdk.list();
        // THEN
        expect(jest.mocked(cli.exec)).toHaveBeenCalledWith(['ls', '--all'], expect.anything());
        expect(stdoutMock.mock.calls[0][0]).toContain('Stack1');
        expect(stdoutMock.mock.calls[1][0]).toContain('Stack2');
    });
    test('does set CDK_DEBUG', async () => {
        // WHEN
        await cdk.list({ debug: true });
        // THEN
        expect(testEnv.mock.calls[0][0]).toHaveProperty('CDK_DEBUG', 'true');
    });
    test('does not set CDK_DEBUG when ', async () => {
        // WHEN
        await cdk.list({ debug: false });
        // THEN
        expect(testEnv.mock.calls[0][0]).not.toHaveProperty('CDK_DEBUG');
    });
});
describe('fromDirectory', () => {
    const cdk = lib_1.AwsCdkCli.fromCdkAppDirectory((0, path_1.join)(__dirname, 'test-app'));
    test('can list all stacks in cdk app', async () => {
        // WHEN
        await cdk.list();
        // THEN
        expect(jest.mocked(cli.exec)).toHaveBeenCalledWith(['ls', '--all']);
        expect(stdoutMock.mock.calls[0][0]).toContain('AppStack1');
        expect(stdoutMock.mock.calls[1][0]).toContain('AppStack2');
    });
});
describe('fromDirectory with config', () => {
    const cdk = lib_1.AwsCdkCli.fromCdkAppDirectory((0, path_1.join)(__dirname, 'test-app'), {
        app: 'node -r ts-node/register app.ts',
        output: 'cdk.out',
    });
    test('can list all stacks in cdk app', async () => {
        // WHEN
        await cdk.list();
        // THEN
        expect(jest.mocked(cli.exec)).toHaveBeenCalledWith([
            'ls', '--all',
            '--app', 'node -r ts-node/register app.ts',
            '--output', 'cdk.out',
        ]);
        expect(stdoutMock.mock.calls[0][0]).toContain('AppStack1');
        expect(stdoutMock.mock.calls[1][0]).toContain('AppStack2');
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjbGkudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUE0QjtBQUM1Qix5Q0FBeUM7QUFDekMsbUNBQW1DO0FBQ25DLGdDQUFtQztBQUVuQyxpRUFBaUU7QUFDakUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFNLENBQUMsQ0FBQztBQUV4QixJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxHQUFHLEVBQUU7SUFDNUIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNuRCxPQUFPO1FBQ0wsR0FBRyxRQUFRO1FBQ1gsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztLQUM3QixDQUFDO0FBQ0osQ0FBQyxDQUFDLENBQUM7QUFDSCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLEdBQUcsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUVsRyxVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsVUFBVSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ3ZCLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDO0FBQ3BDLENBQUMsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDO0FBRXJDLFFBQVEsQ0FBQyxvQ0FBb0MsRUFBRSxHQUFHLEVBQUU7SUFDbEQsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBQzFCLE1BQU0sR0FBRyxHQUFHLGVBQVMsQ0FBQyxrQ0FBa0MsQ0FBQztRQUN2RCxPQUFPLEVB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IH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBjb3JlIGZyb20gJ2F3cy1jZGstbGliL2NvcmUnO1xuaW1wb3J0ICogYXMgY2xpIGZyb20gJ2F3cy1jZGsvbGliJztcbmltcG9ydCB7IEF3c0Nka0NsaSB9IGZyb20gJy4uL2xpYic7XG5cbi8vIFRoZXNlIHRlc3RzIHN5bnRoZXNpemUgYW4gYWN0dWFsIENESyBhcHAgYW5kIHRha2UgYSBiaXQgbG9uZ2VyXG5qZXN0LnNldFRpbWVvdXQoNjBfMDAwKTtcblxuamVzdC5tb2NrKCdhd3MtY2RrL2xpYicsICgpID0+IHtcbiAgY29uc3Qgb3JpZ2luYWwgPSBqZXN0LnJlcXVpcmVBY3R1YWwoJ2F3cy1jZGsvbGliJyk7XG4gIHJldHVybiB7XG4gICAgLi4ub3JpZ2luYWwsXG4gICAgZXhlYzogamVzdC5mbihvcmlnaW5hbC5leGVjKSxcbiAgfTtcbn0pO1xuY29uc3Qgc3Rkb3V0TW9jayA9IGplc3Quc3B5T24ocHJvY2Vzcy5zdGRvdXQsICd3cml0ZScpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7IHJldHVybiB0cnVlOyB9KTtcblxuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIHN0ZG91dE1vY2subW9ja0NsZWFyKCk7XG4gIGplc3QubW9ja2VkKGNsaS5leGVjKS5tb2NrQ2xlYXIoKTtcbn0pO1xuXG5hZnRlckFsbCgoKSA9PiBqZXN0LmNsZWFyQWxsTW9ja3MoKSk7XG5cbmRlc2NyaWJlKCdmcm9tQ2xvdWRBc3NlbWJseURpcmVjdG9yeVByb2R1Y2VyJywgKCkgPT4ge1xuICBjb25zdCB0ZXN0RW52ID0gamVzdC5mbigpO1xuICBjb25zdCBjZGsgPSBBd3NDZGtDbGkuZnJvbUNsb3VkQXNzZW1ibHlEaXJlY3RvcnlQcm9kdWNlcih7XG4gICAgcHJvZHVjZTogYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYXBwID0gbmV3IGNvcmUuQXBwKCk7XG4gICAgICBuZXcgY29yZS5TdGFjayhhcHAsICdTdGFjazEnKTtcbiAgICAgIG5ldyBjb3JlLlN0YWNrKGFwcCwgJ1N0YWNrMicpO1xuXG4gICAgICB0ZXN0RW52KHByb2Nlc3MuZW52KTtcblxuICAgICAgcmV0dXJuIGFwcC5zeW50aCgpLmRpcmVjdG9yeTtcbiAgICB9LFxuICB9KTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICB0ZXN0RW52Lm1vY2tDbGVhcigpO1xuICB9KTtcblxuICB0ZXN0KCdjYW4gbGlzdCBhbGwgc3RhY2tzIGluIGFwcCcsIGFzeW5jICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgYXdhaXQgY2RrLmxpc3QoKTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3QoamVzdC5tb2NrZWQoY2xpLmV4ZWMpKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgIFsnbHMnLCAnLS1hbGwnXSxcbiAgICAgIGV4cGVjdC5hbnl0aGluZygpLFxuICAgICk7XG4gICAgZXhwZWN0KHN0ZG91dE1vY2subW9jay5jYWxsc1swXVswXSkudG9Db250YWluKCdTdGFjazEnKTtcbiAgICBleHBlY3Qoc3Rkb3V0TW9jay5tb2NrLmNhbGxzWzFdWzBdKS50b0NvbnRhaW4oJ1N0YWNrMicpO1xuICB9KTtcblxuICB0ZXN0KCdkb2VzIHNldCBDREtfREVCVUcnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGF3YWl0IGNkay5saXN0KHsgZGVidWc6IHRydWUgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHRlc3RFbnYubW9jay5jYWxsc1swXVswXSkudG9IYXZlUHJvcGVydHkoJ0NES19ERUJVRycsICd0cnVlJyk7XG4gIH0pO1xuXG4gIHRlc3QoJ2RvZXMgbm90IHNldCBDREtfREVCVUcgd2hlbiAnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGF3YWl0IGNkay5saXN0KHsgZGVidWc6IGZhbHNlIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdCh0ZXN0RW52Lm1vY2suY2FsbHNbMF1bMF0pLm5vdC50b0hhdmVQcm9wZXJ0eSgnQ0RLX0RFQlVHJyk7XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKCdmcm9tRGlyZWN0b3J5JywgKCkgPT4ge1xuICBjb25zdCBjZGsgPSBBd3NDZGtDbGkuZnJvbUNka0FwcERpcmVjdG9yeShqb2luKF9fZGlybmFtZSwgJ3Rlc3QtYXBwJykpO1xuXG4gIHRlc3QoJ2NhbiBsaXN0IGFsbCBzdGFja3MgaW4gY2RrIGFwcCcsIGFzeW5jICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgYXdhaXQgY2RrLmxpc3QoKTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3QoamVzdC5tb2NrZWQoY2xpLmV4ZWMpKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgIFsnbHMnLCAnLS1hbGwnXSxcbiAgICApO1xuICAgIGV4cGVjdChzdGRvdXRNb2NrLm1vY2suY2FsbHNbMF1bMF0pLnRvQ29udGFpbignQXBwU3RhY2sxJyk7XG4gICAgZXhwZWN0KHN0ZG91dE1vY2subW9jay5jYWxsc1sxXVswXSkudG9Db250YWluKCdBcHBTdGFjazInKTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ2Zyb21EaXJlY3Rvcnkgd2l0aCBjb25maWcnLCAoKSA9PiB7XG4gIGNvbnN0IGNkayA9IEF3c0Nka0NsaS5mcm9tQ2RrQXBwRGlyZWN0b3J5KGpvaW4oX19kaXJuYW1lLCAndGVzdC1hcHAnKSwge1xuICAgIGFwcDogJ25vZGUgLXIgdHMtbm9kZS9yZWdpc3RlciBhcHAudHMnLFxuICAgIG91dHB1dDogJ2Nkay5vdXQnLFxuICB9KTtcblxuICB0ZXN0KCdjYW4gbGlzdCBhbGwgc3RhY2tzIGluIGNkayBhcHAnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGF3YWl0IGNkay5saXN0KCk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KGplc3QubW9ja2VkKGNsaS5leGVjKSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICBbXG4gICAgICAgICdscycsICctLWFsbCcsXG4gICAgICAgICctLWFwcCcsICdub2RlIC1yIHRzLW5vZGUvcmVnaXN0ZXIgYXBwLnRzJyxcbiAgICAgICAgJy0tb3V0cHV0JywgJ2Nkay5vdXQnLFxuICAgICAgXSxcbiAgICApO1xuICAgIGV4cGVjdChzdGRvdXRNb2NrLm1vY2suY2FsbHNbMF1bMF0pLnRvQ29udGFpbignQXBwU3RhY2sxJyk7XG4gICAgZXhwZWN0KHN0ZG91dE1vY2subW9jay5jYWxsc1sxXVswXSkudG9Db250YWluKCdBcHBTdGFjazInKTtcbiAgfSk7XG59KTtcbiJdfQ==