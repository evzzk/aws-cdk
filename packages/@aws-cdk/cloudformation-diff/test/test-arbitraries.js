"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.arbitraryTemplate = exports.twoArbitraryRules = exports.arbitraryRule = exports.twoArbitraryStatements = exports.arbitraryStatement = void 0;
const fc = require("fast-check");
// We should be testing transitivity as well but it's too much code to generate
// arbitraries that satisfy the precondition enough times to be useful.
function makeNot(obj, key, notKey) {
    if (obj[notKey]) {
        obj[notKey] = obj[key];
        delete obj[key];
    }
    else {
        delete obj[notKey];
    }
}
/**
 * fc.option generates 'null' by default which our code is not robust against
 *
 * Use a variant that always produces 'undefined'.
 */
function maybe(x) {
    return fc.option(x, { nil: undefined });
}
//////////////////////////////////////////////////////////////////////
// IAM
const arbitraryArn = fc.oneof(fc.constantFrom('*', 'arn:resource', { Ref: 'SomeResource' }));
const arbitraryAction = fc.constantFrom('*', 's3:*', 's3:GetObject', 's3:PutObject', { Ref: 'SomeAction' });
const arbitraryPrincipal = fc.oneof(fc.constant(undefined), fc.constant('*'), fc.record({ AWS: fc.oneof(fc.string(), fc.constant('*')) }), fc.record({ Service: fc.string() }), fc.string({ minLength: 1 }).map((svcName) => ({ Service: { 'Fn::Join': ['', [svcName, '.amazonaws.com']] } })), fc.record({ Federated: fc.string() }));
const arbitraryCondition = fc.oneof(fc.constant(undefined), fc.constant({ StringEquals: { Key: 'Value' } }), fc.constant({ StringEquals: { Key: 'Value' }, NumberEquals: { Key: 5 } }));
exports.arbitraryStatement = fc.record({
    Sid: fc.oneof(fc.string(), fc.constant(undefined)),
    Effect: fc.constantFrom('Allow', 'Deny'),
    Resource: fc.array(arbitraryArn, { minLength: 0, maxLength: 2 }),
    NotResource: fc.boolean(),
    Action: fc.array(arbitraryAction, { minLength: 1, maxLength: 2 }),
    NotAction: fc.boolean(),
    Principal: fc.array(arbitraryPrincipal, { minLength: 0, maxLength: 2 }),
    NotPrincipal: fc.boolean(),
    Condition: arbitraryCondition,
}).map(record => {
    // This map() that shuffles keys is the easiest way to create variation between Action/NotAction etc.
    makeNot(record, 'Resource', 'NotResource');
    makeNot(record, 'Action', 'NotAction');
    makeNot(record, 'Principal', 'NotPrincipal');
    return record;
});
/**
 * Two statements where one is a modification of the other
 *
 * This is to generate two statements that have a higher chance of being similar
 * than generating two arbitrary statements independently.
 */
exports.twoArbitraryStatements = fc.record({
    statement1: exports.arbitraryStatement,
    statement2: exports.arbitraryStatement,
    copySid: fc.boolean(),
    copyEffect: fc.boolean(),
    copyResource: fc.boolean(),
    copyAction: fc.boolean(),
    copyPrincipal: fc.boolean(),
    copyCondition: fc.boolean(),
}).map(op => {
    const original = op.statement1;
    const modified = Object.create(original, {});
    if (op.copySid) {
        modified.Sid = op.statement2.Sid;
    }
    if (op.copyEffect) {
        modified.Effect = op.statement2.Effect;
    }
    if (op.copyResource) {
        modified.Resource = op.statement2.Resource;
        modified.NotResource = op.statement2.NotResource;
    }
    if (op.copyAction) {
        modified.Action = op.statement2.Action;
        modified.NotAction = op.statement2.NotAction;
    }
    if (op.copyPrincipal) {
        modified.Principal = op.statement2.Principal;
        modified.NotPrincipal = op.statement2.NotPrincipal;
    }
    if (op.copyCondition) {
        modified.Condition = op.statement2.Condition;
    }
    return { statement1: original, statement2: modified };
});
//////////////////////////////////////////////////////////////////////
//  SECURITY GROUPS
exports.arbitraryRule = fc.record({
    IpProtocol: fc.constantFrom('tcp', 'udp', 'icmp'),
    FromPort: fc.integer({ min: 80, max: 81 }),
    ToPort: fc.integer({ min: 81, max: 82 }),
    CidrIp: fc.constantFrom('0.0.0.0/0', '1.2.3.4/8', undefined, undefined),
    DestinationSecurityGroupId: fc.constantFrom('sg-1234', undefined),
    DestinationPrefixListId: fc.constantFrom('pl-1', undefined),
});
exports.twoArbitraryRules = fc.record({
    rule1: exports.arbitraryRule,
    rule2: exports.arbitraryRule,
    copyIp: fc.boolean(),
    copyFromPort: fc.boolean(),
    copyToPort: fc.boolean(),
    copyCidrIp: fc.boolean(),
    copySecurityGroupId: fc.boolean(),
    copyPrefixListId: fc.boolean(),
}).map(op => {
    const original = op.rule1;
    const modified = Object.create(original, {});
    if (op.copyIp) {
        modified.IpProtocol = op.rule2.IpProtocol;
    }
    if (op.copyFromPort) {
        modified.FromPort = op.rule2.FromPort;
    }
    if (op.copyToPort) {
        modified.ToPort = op.rule2.ToPort;
    }
    if (op.copyCidrIp) {
        modified.CidrIp = op.rule2.CidrIp;
    }
    if (op.copySecurityGroupId) {
        modified.DestinationSecurityGroupId = op.rule2.DestinationSecurityGroupId;
    }
    if (op.copyPrefixListId) {
        modified.DestinationPrefixListId = op.rule2.DestinationPrefixListId;
    }
    return { rule1: original, rule2: modified };
});
function maybeIntrinsic(x) {
    return fc.oneof(x, x.map((value) => ({ 'Fn::If': ['Condition', value, { Ref: 'AWS::NoValue' }] })));
}
const arbitraryPolicyDocument = fc.record({
    Version: fc.constant('2012-10-17'),
    Statement: maybeIntrinsic(fc.array(maybeIntrinsic(exports.arbitraryStatement), { maxLength: 5 })),
});
//////////////////////////////////////////////////////////////////////
// Generate a template with a subset of a predefined number of resources in it
const arbitraryRole = fc.record({
    AssumeRolePolicyDocument: arbitraryPolicyDocument,
    ManagedPolicyArns: maybe(maybeIntrinsic(fc.array(arbitraryArn, { maxLength: 2 }))),
    Policies: maybe(maybeIntrinsic(fc.array(maybeIntrinsic(fc.record({
        PolicyName: fc.hexaString(),
        PolicyDocument: maybeIntrinsic(arbitraryPolicyDocument),
    })), { maxLength: 3 }))),
});
const arbitraryPolicy = fc.record({
    PolicyName: fc.hexaString(),
    PolicyDocument: maybeIntrinsic(arbitraryPolicyDocument),
});
const arbitraryBucketPolicy = fc.record({
    PolicyDocument: maybeIntrinsic(arbitraryPolicyDocument),
});
const arbitraryIngress = fc.record({
    CidrIp: maybe(fc.hexaString()),
    CidrIpv6: maybe(fc.hexaString()),
    Description: maybe(fc.hexaString()),
    FromPort: maybe(fc.integer()),
    IpProtocol: fc.hexaString(),
    SourcePrefixListId: maybe(fc.hexaString()),
    SourceSecurityGroupId: maybe(fc.hexaString()),
    ToPort: maybe(fc.integer()),
});
const arbitraryEgress = fc.record({
    CidrIp: maybe(fc.hexaString()),
    CidrIpv6: maybe(fc.hexaString()),
    Description: maybe(fc.hexaString()),
    DestinationPrefixListId: maybe(fc.hexaString()),
    DestinationSecurityGroupId: maybe(fc.hexaString()),
    IpProtocol: fc.hexaString(),
    FromPort: maybe(fc.integer()),
    ToPort: maybe(fc.integer()),
});
const arbitrarySecurityGroup = fc.record({
    SecurityGroupIngress: maybe(maybeIntrinsic(fc.array(maybeIntrinsic(arbitraryIngress), { maxLength: 5 }))),
    SecurityGroupEgress: maybe(maybeIntrinsic(fc.array(maybeIntrinsic(arbitraryEgress), { maxLength: 5 }))),
});
exports.arbitraryTemplate = fc.record({
    role: maybe(arbitraryRole),
    policy: maybe(arbitraryPolicy),
    bucketWithPolicy: maybe(arbitraryBucketPolicy),
    securityGroup: maybe(arbitrarySecurityGroup),
    ingressRule: maybe(arbitraryIngress),
    egressRule: maybe(arbitraryEgress),
}).map((generate) => {
    return {
        Resources: Object.assign({}, mapVal(generate.role, (roleProps) => ({
            MyRole: {
                Type: 'AWS::IAM::Role',
                Properties: roleProps,
            },
        })), mapVal(generate.role && generate.policy, (policyProps) => ({
            MyPolicy: {
                Type: 'AWS::IAM::Policy',
                Properties: {
                    Roles: [{ Ref: 'MyRole' }],
                    ...policyProps,
                },
            },
        })), mapVal(generate.bucketWithPolicy, (bucketPol) => ({
            MyBucket: {
                Type: 'AWS::S3::Bucket',
            },
            MyBucketPolicy: {
                Type: 'AWS::S3::BucketPolicy',
                Properties: {
                    Bucket: { Ref: 'MyBucket' },
                    ...bucketPol,
                },
            },
        })), mapVal(generate.securityGroup, (sgProps) => ({
            MySecurityGroup: {
                Type: 'AWS::EC2::SecurityGroup',
                Properties: sgProps,
            },
        })), mapVal(generate.securityGroup && generate.ingressRule, (ingressProps) => ({
            MyIngress: {
                Type: 'AWS::EC2::SecurityGroupIngress',
                Properties: {
                    GroupId: { Ref: 'MySecurityGroup' },
                    ...ingressProps,
                },
            },
        })), mapVal(generate.securityGroup && generate.egressRule, (egressProps) => ({
            MyEgress: {
                Type: 'AWS::EC2::SecurityGroupEgress',
                Properties: {
                    GroupId: { Ref: 'MySecurityGroup' },
                    ...egressProps,
                },
            },
        }))),
    };
    function mapVal(cond, cb) {
        return cond ? cb(cond) : {};
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1hcmJpdHJhcmllcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRlc3QtYXJiaXRyYXJpZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsaUNBQWlDO0FBRWpDLCtFQUErRTtBQUMvRSx1RUFBdUU7QUFFdkUsU0FBUyxPQUFPLENBQUMsR0FBUSxFQUFFLEdBQVcsRUFBRSxNQUFjO0lBQ3BELElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7UUFDaEIsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN2QixPQUFPLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNsQixDQUFDO1NBQU0sQ0FBQztRQUNOLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3JCLENBQUM7QUFDSCxDQUFDO0FBRUQ7Ozs7R0FJRztBQUNILFNBQVMsS0FBSyxDQUFJLENBQWtCO0lBQ2xDLE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztBQUMxQyxDQUFDO0FBRUQsc0VBQXNFO0FBQ3RFLE1BQU07QUFFTixNQUFNLFlBQVksR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFLGNBQWMsRUFBRSxFQUFFLEdBQUcsRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDN0YsTUFBTSxlQUFlLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztBQUM1RyxNQUFNLGtCQUFrQixHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQ2pDLEVBQUUsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQ3RCLEVBQUUsQ0FBQyxRQUFRLENBQUMsR0FB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UUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsQ0FBQztZQUN4RSxTQUFTLEVBQUU7Z0JBQ1QsSUFBSSxFQUFFLGdDQUFnQztnQkFDdEMsVUFBVSxFQUFFO29CQUNWLE9BQU8sRUFBRSxFQUFFLEdBQUcsRUFBRSxpQkFBaUIsRUFBRTtvQkFDbkMsR0FBRyxZQUFZO2lCQUNoQjthQUNGO1NBQ0YsQ0FBQyxDQUFDLEVBQ0gsTUFBTSxDQUFDLFFBQVEsQ0FBQyxhQUFhLElBQUksUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUN0RSxRQUFRLEVBQUU7Z0JBQ1IsSUFBSSxFQUFFLCtCQUErQjtnQkFDckMsVUFBVSxFQUFFO29CQUNWLE9BQU8sRUFBRSxFQUFFLEdBQUcsRUFBRSxpQkFBaUIsRUFBRTtvQkFDbkMsR0FBRyxXQUFXO2lCQUNmO2FBQ0Y7U0FDRixDQUFDLENBQUMsQ0FDSjtLQUNGLENBQUM7SUFFRixTQUFTLE1BQU0sQ0FBTyxJQUFPLEVBQUUsRUFBNEI7UUFDekQsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQzlCLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZjIGZyb20gJ2Zhc3QtY2hlY2snO1xuXG4vLyBXZSBzaG91bGQgYmUgdGVzdGluZyB0cmFuc2l0aXZpdHkgYXMgd2VsbCBidXQgaXQncyB0b28gbXVjaCBjb2RlIHRvIGdlbmVyYXRlXG4vLyBhcmJpdHJhcmllcyB0aGF0IHNhdGlzZnkgdGhlIHByZWNvbmRpdGlvbiBlbm91Z2ggdGltZXMgdG8gYmUgdXNlZnVsLlxuXG5mdW5jdGlvbiBtYWtlTm90KG9iajogYW55LCBrZXk6IHN0cmluZywgbm90S2V5OiBzdHJpbmcpIHtcbiAgaWYgKG9ialtub3RLZXldKSB7XG4gICAgb2JqW25vdEtleV0gPSBvYmpba2V5XTtcbiAgICBkZWxldGUgb2JqW2tleV07XG4gIH0gZWxzZSB7XG4gICAgZGVsZXRlIG9ialtub3RLZXldO1xuICB9XG59XG5cbi8qKlxuICogZmMub3B0aW9uIGdlbmVyYXRlcyAnbnVsbCcgYnkgZGVmYXVsdCB3aGljaCBvdXIgY29kZSBpcyBub3Qgcm9idXN0IGFnYWluc3RcbiAqXG4gKiBVc2UgYSB2YXJpYW50IHRoYXQgYWx3YXlzIHByb2R1Y2VzICd1bmRlZmluZWQnLlxuICovXG5mdW5jdGlvbiBtYXliZTxBPih4OiBmYy5BcmJpdHJhcnk8QT4pIHtcbiAgcmV0dXJuIGZjLm9wdGlvbih4LCB7IG5pbDogdW5kZWZpbmVkIH0pO1xufVxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJQU1cblxuY29uc3QgYXJiaXRyYXJ5QXJuID0gZmMub25lb2YoZmMuY29uc3RhbnRGcm9tKCcqJywgJ2FybjpyZXNvdXJjZScsIHsgUmVmOiAnU29tZVJlc291cmNlJyB9KSk7XG5jb25zdCBhcmJpdHJhcnlBY3Rpb24gPSBmYy5jb25zdGFudEZyb20oJyonLCAnczM6KicsICdzMzpHZXRPYmplY3QnLCAnczM6UHV0T2JqZWN0JywgeyBSZWY6ICdTb21lQWN0aW9uJyB9KTtcbmNvbnN0IGFyYml0cmFyeVByaW5jaXBhbCA9IGZjLm9uZW9mPGFueT4oXG4gIGZjLmNvbnN0YW50KHVuZGVmaW5lZCksXG4gIGZjLmNvbnN0YW50KCcqJyksXG4gIGZjLnJlY29yZCh7IEFXUzogZmMub25lb2YoZmMuc3RyaW5nKCksIGZjLmNvbnN0YW50KCcqJykpIH0pLFxuICBmYy5yZWNvcmQoeyBTZXJ2aWNlOiBmYy5zdHJpbmcoKSB9KSxcbiAgZmMuc3RyaW5nKHsgbWluTGVuZ3RoOiAxIH0pLm1hcCgoc3ZjTmFtZSkgPT4gKHsgU2VydmljZTogeyAnRm46OkpvaW4nOiBbJycsIFtzdmNOYW1lLCAnLmFtYXpvbmF3cy5jb20nXV0gfSB9KSksXG4gIGZjLnJlY29yZCh7IEZlZGVyYXRlZDogZmMuc3RyaW5nKCkgfSksXG4pO1xuY29uc3QgYXJiaXRyYXJ5Q29uZGl0aW9uID0gZmMub25lb2YoXG4gIGZjLmNvbnN0YW50KHVuZGVmaW5lZCksXG4gIGZjLmNvbnN0YW50KHsgU3RyaW5nRXF1YWxzOiB7IEtleTogJ1ZhbHVlJyB9IH0pLFxuICBmYy5jb25zdGFudCh7IFN0cmluZ0VxdWFsczogeyBLZXk6ICdWYWx1ZScgfSwgTnVtYmVyRXF1YWxzOiB7IEtleTogNSB9IH0pLFxuKTtcblxuZXhwb3J0IGNvbnN0IGFyYml0cmFyeVN0YXRlbWVudCA9IGZjLnJlY29yZCh7XG4gIFNpZDogZmMub25lb2YoZmMuc3RyaW5nKCksIGZjLmNvbnN0YW50KHVuZGVmaW5lZCkpLFxuICBFZmZlY3Q6IGZjLmNvbnN0YW50RnJvbSgnQWxsb3cnLCAnRGVueScpLFxuICBSZXNvdXJjZTogZmMuYXJyYXkoYXJiaXRyYXJ5QXJuLCB7IG1pbkxlbmd0aDogMCwgbWF4TGVuZ3RoOiAyIH0pLFxuICBOb3RSZXNvdXJjZTogZmMuYm9vbGVhbigpLFxuICBBY3Rpb246IGZjLmFycmF5KGFyYml0cmFyeUFjdGlvbiwgeyBtaW5MZW5ndGg6IDEsIG1heExlbmd0aDogMiB9KSxcbiAgTm90QWN0aW9uOiBmYy5ib29sZWFuKCksXG4gIFByaW5jaXBhbDogZmMuYXJyYXkoYXJiaXRyYXJ5UHJpbmNpcGFsLCB7IG1pbkxlbmd0aDogMCwgbWF4TGVuZ3RoOiAyIH0pLFxuICBOb3RQcmluY2lwYWw6IGZjLmJvb2xlYW4oKSxcbiAgQ29uZGl0aW9uOiBhcmJpdHJhcnlDb25kaXRpb24sXG59KS5tYXAocmVjb3JkID0+IHtcbiAgLy8gVGhpcyBtYXAoKSB0aGF0IHNodWZmbGVzIGtleXMgaXMgdGhlIGVhc2llc3Qgd2F5IHRvIGNyZWF0ZSB2YXJpYXRpb24gYmV0d2VlbiBBY3Rpb24vTm90QWN0aW9uIGV0Yy5cbiAgbWFrZU5vdChyZWNvcmQsICdSZXNvdXJjZScsICdOb3RSZXNvdXJjZScpO1xuICBtYWtlTm90KHJlY29yZCwgJ0FjdGlvbicsICdOb3RBY3Rpb24nKTtcbiAgbWFrZU5vdChyZWNvcmQsICdQcmluY2lwYWwnLCAnTm90UHJpbmNpcGFsJyk7XG4gIHJldHVybiByZWNvcmQ7XG59KTtcblxuLyoqXG4gKiBUd28gc3RhdGVtZW50cyB3aGVyZSBvbmUgaXMgYSBtb2RpZmljYXRpb24gb2YgdGhlIG90aGVyXG4gKlxuICogVGhpcyBpcyB0byBnZW5lcmF0ZSB0d28gc3RhdGVtZW50cyB0aGF0IGhhdmUgYSBoaWdoZXIgY2hhbmNlIG9mIGJlaW5nIHNpbWlsYXJcbiAqIHRoYW4gZ2VuZXJhdGluZyB0d28gYXJiaXRyYXJ5IHN0YXRlbWVudHMgaW5kZXBlbmRlbnRseS5cbiAqL1xuZXhwb3J0IGNvbnN0IHR3b0FyYml0cmFyeVN0YXRlbWVudHMgPSBmYy5yZWNvcmQoe1xuICBzdGF0ZW1lbnQxOiBhcmJpdHJhcnlTdGF0ZW1lbnQsXG4gIHN0YXRlbWVudDI6IGFyYml0cmFyeVN0YXRlbWVudCxcbiAgY29weVNpZDogZmMuYm9vbGVhbigpLFxuICBjb3B5RWZmZWN0OiBmYy5ib29sZWFuKCksXG4gIGNvcHlSZXNvdXJjZTogZmMuYm9vbGVhbigpLFxuICBjb3B5QWN0aW9uOiBmYy5ib29sZWFuKCksXG4gIGNvcHlQcmluY2lwYWw6IGZjLmJvb2xlYW4oKSxcbiAgY29weUNvbmRpdGlvbjogZmMuYm9vbGVhbigpLFxufSkubWFwKG9wID0+IHtcbiAgY29uc3Qgb3JpZ2luYWwgPSBvcC5zdGF0ZW1lbnQxO1xuICBjb25zdCBtb2RpZmllZCA9IE9iamVjdC5jcmVhdGUob3JpZ2luYWwsIHt9KTtcblxuICBpZiAob3AuY29weVNpZCkgeyBtb2RpZmllZC5TaWQgPSBvcC5zdGF0ZW1lbnQyLlNpZDsgfVxuICBpZiAob3AuY29weUVmZmVjdCkgeyBtb2RpZmllZC5FZmZlY3QgPSBvcC5zdGF0ZW1lbnQyLkVmZmVjdDsgfVxuICBpZiAob3AuY29weVJlc291cmNlKSB7IG1vZGlmaWVkLlJlc291cmNlID0gb3Auc3RhdGVtZW50Mi5SZXNvdXJjZTsgbW9kaWZpZWQuTm90UmVzb3VyY2UgPSBvcC5zdGF0ZW1lbnQyLk5vdFJlc291cmNlOyB9XG4gIGlmIChvcC5jb3B5QWN0aW9uKSB7IG1vZGlmaWVkLkFjdGlvbiA9IG9wLnN0YXRlbWVudDIuQWN0aW9uOyBtb2RpZmllZC5Ob3RBY3Rpb24gPSBvcC5zdGF0ZW1lbnQyLk5vdEFjdGlvbjsgfVxuICBpZiAob3AuY29weVByaW5jaXBhbCkgeyBtb2RpZmllZC5QcmluY2lwYWwgPSBvcC5zdGF0ZW1lbnQyLlByaW5jaXBhbDsgbW9kaWZpZWQuTm90UHJpbmNpcGFsID0gb3Auc3RhdGVtZW50Mi5Ob3RQcmluY2lwYWw7IH1cbiAgaWYgKG9wLmNvcHlDb25kaXRpb24pIHsgbW9kaWZpZWQuQ29uZGl0aW9uID0gb3Auc3RhdGVtZW50Mi5Db25kaXRpb247IH1cblxuICByZXR1cm4geyBzdGF0ZW1lbnQxOiBvcmlnaW5hbCwgc3RhdGVtZW50MjogbW9kaWZpZWQgfTtcbn0pO1xuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyAgU0VDVVJJVFkgR1JPVVBTXG5cbmV4cG9ydCBjb25zdCBhcmJpdHJhcnlSdWxlID0gZmMucmVjb3JkKHtcbiAgSXBQcm90b2NvbDogZmMuY29uc3RhbnRGcm9tKCd0Y3AnLCAndWRwJywgJ2ljbXAnKSxcbiAgRnJvbVBvcnQ6IGZjLmludGVnZXIoeyBtaW46IDgwLCBtYXg6IDgxIH0pLFxuICBUb1BvcnQ6IGZjLmludGVnZXIoeyBtaW46IDgxLCBtYXg6IDgyIH0pLFxuICBDaWRySXA6IGZjLmNvbnN0YW50RnJvbSgnMC4wLjAuMC8wJywgJzEuMi4zLjQvOCcsIHVuZGVmaW5lZCwgdW5kZWZpbmVkKSxcbiAgRGVzdGluYXRpb25TZWN1cml0eUdyb3VwSWQ6IGZjLmNvbnN0YW50RnJvbSgnc2ctMTIzNCcsIHVuZGVmaW5lZCksXG4gIERlc3RpbmF0aW9uUHJlZml4TGlzdElkOiBmYy5jb25zdGFudEZyb20oJ3BsLTEnLCB1bmRlZmluZWQpLFxufSk7XG5cbmV4cG9ydCBjb25zdCB0d29BcmJpdHJhcnlSdWxlcyA9IGZjLnJlY29yZCh7XG4gIHJ1bGUxOiBhcmJpdHJhcnlSdWxlLFxuICBydWxlMjogYXJiaXRyYXJ5UnVsZSxcbiAgY29weUlwOiBmYy5ib29sZWFuKCksXG4gIGNvcHlGcm9tUG9ydDogZmMuYm9vbGVhbigpLFxuICBjb3B5VG9Qb3J0OiBmYy5ib29sZWFuKCksXG4gIGNvcHlDaWRySXA6IGZjLmJvb2xlYW4oKSxcbiAgY29weVNlY3VyaXR5R3JvdXBJZDogZmMuYm9vbGVhbigpLFxuICBjb3B5UHJlZml4TGlzdElkOiBmYy5ib29sZWFuKCksXG59KS5tYXAob3AgPT4ge1xuICBjb25zdCBvcmlnaW5hbCA9IG9wLnJ1bGUxO1xuICBjb25zdCBtb2RpZmllZCA9IE9iamVjdC5jcmVhdGUob3JpZ2luYWwsIHt9KTtcblxuICBpZiAob3AuY29weUlwKSB7IG1vZGlmaWVkLklwUHJvdG9jb2wgPSBvcC5ydWxlMi5JcFByb3RvY29sOyB9XG4gIGlmIChvcC5jb3B5RnJvbVBvcnQpIHsgbW9kaWZpZWQuRnJvbVBvcnQgPSBvcC5ydWxlMi5Gcm9tUG9ydDsgfVxuICBpZiAob3AuY29weVRvUG9ydCkgeyBtb2RpZmllZC5Ub1BvcnQgPSBvcC5ydWxlMi5Ub1BvcnQ7IH1cbiAgaWYgKG9wLmNvcHlDaWRySXApIHsgbW9kaWZpZWQuQ2lkcklwID0gb3AucnVsZTIuQ2lkcklwOyB9XG4gIGlmIChvcC5jb3B5U2VjdXJpdHlHcm91cElkKSB7IG1vZGlmaWVkLkRlc3RpbmF0aW9uU2VjdXJpdHlHcm91cElkID0gb3AucnVsZTIuRGVzdGluYXRpb25TZWN1cml0eUdyb3VwSWQ7IH1cbiAgaWYgKG9wLmNvcHlQcmVmaXhMaXN0SWQpIHsgbW9kaWZpZWQuRGVzdGluYXRpb25QcmVmaXhMaXN0SWQgPSBvcC5ydWxlMi5EZXN0aW5hdGlvblByZWZpeExpc3RJZDsgfVxuXG4gIHJldHVybiB7IHJ1bGUxOiBvcmlnaW5hbCwgcnVsZTI6IG1vZGlmaWVkIH07XG59KTtcblxuZnVuY3Rpb24gbWF5YmVJbnRyaW5zaWM8QT4oeDogZmMuQXJiaXRyYXJ5PEE+KSB7XG4gIHJldHVybiBmYy5vbmVvZihcbiAgICB4LFxuICAgIHgubWFwKCh2YWx1ZSkgPT4gKHsgJ0ZuOjpJZic6IFsnQ29uZGl0aW9uJywgdmFsdWUsIHsgUmVmOiAnQVdTOjpOb1ZhbHVlJyB9XSB9KSksXG4gICk7XG59XG5cbmNvbnN0IGFyYml0cmFyeVBvbGljeURvY3VtZW50ID0gZmMucmVjb3JkKHtcbiAgVmVyc2lvbjogZmMuY29uc3RhbnQoJzIwMTItMTAtMTcnKSxcbiAgU3RhdGVtZW50OiBtYXliZUludHJpbnNpYyhmYy5hcnJheShtYXliZUludHJpbnNpYyhhcmJpdHJhcnlTdGF0ZW1lbnQpLCB7IG1heExlbmd0aDogNSB9KSksXG59KTtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gR2VuZXJhdGUgYSB0ZW1wbGF0ZSB3aXRoIGEgc3Vic2V0IG9mIGEgcHJlZGVmaW5lZCBudW1iZXIgb2YgcmVzb3VyY2VzIGluIGl0XG5cbmNvbnN0IGFyYml0cmFyeVJvbGUgPSBmYy5yZWNvcmQoe1xuICBBc3N1bWVSb2xlUG9saWN5RG9jdW1lbnQ6IGFyYml0cmFyeVBvbGljeURvY3VtZW50LFxuICBNYW5hZ2VkUG9saWN5QXJuczogbWF5YmUobWF5YmVJbnRyaW5zaWMoZmMuYXJyYXkoYXJiaXRyYXJ5QXJuLCB7IG1heExlbmd0aDogMiB9KSkpLFxuICBQb2xpY2llczogbWF5YmUobWF5YmVJbnRyaW5zaWMoZmMuYXJyYXkobWF5YmVJbnRyaW5zaWMoZmMucmVjb3JkKHtcbiAgICBQb2xpY3lOYW1lOiBmYy5oZXhhU3RyaW5nKCksXG4gICAgUG9saWN5RG9jdW1lbnQ6IG1heWJlSW50cmluc2ljKGFyYml0cmFyeVBvbGljeURvY3VtZW50KSxcbiAgfSkpLCB7IG1heExlbmd0aDogMyB9KSkpLFxufSk7XG5cbmNvbnN0IGFyYml0cmFyeVBvbGljeSA9IGZjLnJlY29yZCh7XG4gIFBvbGljeU5hbWU6IGZjLmhleGFTdHJpbmcoKSxcbiAgUG9saWN5RG9jdW1lbnQ6IG1heWJlSW50cmluc2ljKGFyYml0cmFyeVBvbGljeURvY3VtZW50KSxcbn0pO1xuXG5jb25zdCBhcmJpdHJhcnlCdWNrZXRQb2xpY3kgPSBmYy5yZWNvcmQoe1xuICBQb2xpY3lEb2N1bWVudDogbWF5YmVJbnRyaW5zaWMoYXJiaXRyYXJ5UG9saWN5RG9jdW1lbnQpLFxufSk7XG5cbmNvbnN0IGFyYml0cmFyeUluZ3Jlc3MgPSBmYy5yZWNvcmQoe1xuICBDaWRySXA6IG1heWJlKGZjLmhleGFTdHJpbmcoKSksXG4gIENpZHJJcHY2OiBtYXliZShmYy5oZXhhU3RyaW5nKCkpLFxuICBEZXNjcmlwdGlvbjogbWF5YmUoZmMuaGV4YVN0cmluZygpKSxcbiAgRnJvbVBvcnQ6IG1heWJlKGZjLmludGVnZXIoKSksXG4gIElwUHJvdG9jb2w6IGZjLmhleGFTdHJpbmcoKSxcbiAgU291cmNlUHJlZml4TGlzdElkOiBtYXliZShmYy5oZXhhU3RyaW5nKCkpLFxuICBTb3VyY2VTZWN1cml0eUdyb3VwSWQ6IG1heWJlKGZjLmhleGFTdHJpbmcoKSksXG4gIFRvUG9ydDogbWF5YmUoZmMuaW50ZWdlcigpKSxcbn0pO1xuXG5jb25zdCBhcmJpdHJhcnlFZ3Jlc3MgPSBmYy5yZWNvcmQoe1xuICBDaWRySXA6IG1heWJlKGZjLmhleGFTdHJpbmcoKSksXG4gIENpZHJJcHY2OiBtYXliZShmYy5oZXhhU3RyaW5nKCkpLFxuICBEZXNjcmlwdGlvbjogbWF5YmUoZmMuaGV4YVN0cmluZygpKSxcbiAgRGVzdGluYXRpb25QcmVmaXhMaXN0SWQ6IG1heWJlKGZjLmhleGFTdHJpbmcoKSksXG4gIERlc3RpbmF0aW9uU2VjdXJpdHlHcm91cElkOiBtYXliZShmYy5oZXhhU3RyaW5nKCkpLFxuICBJcFByb3RvY29sOiBmYy5oZXhhU3RyaW5nKCksXG4gIEZyb21Qb3J0OiBtYXliZShmYy5pbnRlZ2VyKCkpLFxuICBUb1BvcnQ6IG1heWJlKGZjLmludGVnZXIoKSksXG59KTtcblxuY29uc3QgYXJiaXRyYXJ5U2VjdXJpdHlHcm91cCA9IGZjLnJlY29yZCh7XG4gIFNlY3VyaXR5R3JvdXBJbmdyZXNzOiBtYXliZShtYXliZUludHJpbnNpYyhmYy5hcnJheShtYXliZUludHJpbnNpYyhhcmJpdHJhcnlJbmdyZXNzKSwgeyBtYXhMZW5ndGg6IDUgfSkpKSxcbiAgU2VjdXJpdHlHcm91cEVncmVzczogbWF5YmUobWF5YmVJbnRyaW5zaWMoZmMuYXJyYXkobWF5YmVJbnRyaW5zaWMoYXJiaXRyYXJ5RWdyZXNzKSwgeyBtYXhMZW5ndGg6IDUgfSkpKSxcbn0pO1xuXG5leHBvcnQgY29uc3QgYXJiaXRyYXJ5VGVtcGxhdGUgPSBmYy5yZWNvcmQoe1xuICByb2xlOiBtYXliZShhcmJpdHJhcnlSb2xlKSxcbiAgcG9saWN5OiBtYXliZShhcmJpdHJhcnlQb2xpY3kpLFxuICBidWNrZXRXaXRoUG9saWN5OiBtYXliZShhcmJpdHJhcnlCdWNrZXRQb2xpY3kpLFxuICBzZWN1cml0eUdyb3VwOiBtYXliZShhcmJpdHJhcnlTZWN1cml0eUdyb3VwKSxcbiAgaW5ncmVzc1J1bGU6IG1heWJlKGFyYml0cmFyeUluZ3Jlc3MpLFxuICBlZ3Jlc3NSdWxlOiBtYXliZShhcmJpdHJhcnlFZ3Jlc3MpLFxufSkubWFwKChnZW5lcmF0ZSkgPT4ge1xuICByZXR1cm4ge1xuICAgIFJlc291cmNlczogT2JqZWN0LmFzc2lnbihcbiAgICAgIHt9LFxuICAgICAgbWFwVmFsKGdlbmVyYXRlLnJvbGUsIChyb2xlUHJvcHMpID0+ICh7XG4gICAgICAgIE15Um9sZToge1xuICAgICAgICAgIFR5cGU6ICdBV1M6OklBTTo6Um9sZScsXG4gICAgICAgICAgUHJvcGVydGllczogcm9sZVByb3BzLFxuICAgICAgICB9LFxuICAgICAgfSkpLFxuICAgICAgbWFwVmFsKGdlbmVyYXRlLnJvbGUgJiYgZ2VuZXJhdGUucG9saWN5LCAocG9saWN5UHJvcHMpID0+ICh7XG4gICAgICAgIE15UG9saWN5OiB7XG4gICAgICAgICAgVHlwZTogJ0FXUzo6SUFNOjpQb2xpY3knLFxuICAgICAgICAgIFByb3BlcnRpZXM6IHtcbiAgICAgICAgICAgIFJvbGVzOiBbeyBSZWY6ICdNeVJvbGUnIH1dLFxuICAgICAgICAgICAgLi4ucG9saWN5UHJvcHMsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pKSxcbiAgICAgIG1hcFZhbChnZW5lcmF0ZS5idWNrZXRXaXRoUG9saWN5LCAoYnVja2V0UG9sKSA9PiAoe1xuICAgICAgICBNeUJ1Y2tldDoge1xuICAgICAgICAgIFR5cGU6ICdBV1M6OlMzOjpCdWNrZXQnLFxuICAgICAgICB9LFxuICAgICAgICBNeUJ1Y2tldFBvbGljeToge1xuICAgICAgICAgIFR5cGU6ICdBV1M6OlMzOjpCdWNrZXRQb2xpY3knLFxuICAgICAgICAgIFByb3BlcnRpZXM6IHtcbiAgICAgICAgICAgIEJ1Y2tldDogeyBSZWY6ICdNeUJ1Y2tldCcgfSxcbiAgICAgICAgICAgIC4uLmJ1Y2tldFBvbCxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSkpLFxuICAgICAgbWFwVmFsKGdlbmVyYXRlLnNlY3VyaXR5R3JvdXAsIChzZ1Byb3BzKSA9PiAoe1xuICAgICAgICBNeVNlY3VyaXR5R3JvdXA6IHtcbiAgICAgICAgICBUeXBlOiAnQVdTOjpFQzI6OlNlY3VyaXR5R3JvdXAnLFxuICAgICAgICAgIFByb3BlcnRpZXM6IHNnUHJvcHMsXG4gICAgICAgIH0sXG4gICAgICB9KSksXG4gICAgICBtYXBWYWwoZ2VuZXJhdGUuc2VjdXJpdHlHcm91cCAmJiBnZW5lcmF0ZS5pbmdyZXNzUnVsZSwgKGluZ3Jlc3NQcm9wcykgPT4gKHtcbiAgICAgICAgTXlJbmdyZXNzOiB7XG4gICAgICAgICAgVHlwZTogJ0FXUzo6RUMyOjpTZWN1cml0eUdyb3VwSW5ncmVzcycsXG4gICAgICAgICAgUHJvcGVydGllczoge1xuICAgICAgICAgICAgR3JvdXBJZDogeyBSZWY6ICdNeVNlY3VyaXR5R3JvdXAnIH0sXG4gICAgICAgICAgICAuLi5pbmdyZXNzUHJvcHMsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pKSxcbiAgICAgIG1hcFZhbChnZW5lcmF0ZS5zZWN1cml0eUdyb3VwICYmIGdlbmVyYXRlLmVncmVzc1J1bGUsIChlZ3Jlc3NQcm9wcykgPT4gKHtcbiAgICAgICAgTXlFZ3Jlc3M6IHtcbiAgICAgICAgICBUeXBlOiAnQVdTOjpFQzI6OlNlY3VyaXR5R3JvdXBFZ3Jlc3MnLFxuICAgICAgICAgIFByb3BlcnRpZXM6IHtcbiAgICAgICAgICAgIEdyb3VwSWQ6IHsgUmVmOiAnTXlTZWN1cml0eUdyb3VwJyB9LFxuICAgICAgICAgICAgLi4uZWdyZXNzUHJvcHMsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pKSxcbiAgICApLFxuICB9O1xuXG4gIGZ1bmN0aW9uIG1hcFZhbDxBLCBCPihjb25kOiBBLCBjYjogKHg6IE5vbk51bGxhYmxlPEE+KSA9PiBCKTogQiB8IHt9IHtcbiAgICByZXR1cm4gY29uZCA/IGNiKGNvbmQpIDoge307XG4gIH1cbn0pO1xuIl19